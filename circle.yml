machine:
  node:
    version: 6.10.3
dependencies:
  pre:
    - npm install git+ssh://git@github.com:holidayextras/deployment-helpers.git
    - node_modules/deployment-helpers/nodeApps/preRelease.sh
    - npm install grunt grunt-cli istanbul mocha -g
test:
  pre:
    - mkdir -p $CIRCLE_TEST_REPORTS/unit
    - mkdir -p $CIRCLE_TEST_REPORTS/coverage
  override:
    - npm run lint
    - istanbul cover _mocha --  --timeout 15000 --recursive test/**/*Test.js -R xunit > $CIRCLE_TEST_REPORTS/unit/results.xml
  post:
    - cp -r ./coverage/ $CIRCLE_ARTIFACTS/coverage
    - echo "$GRAPHITE_API_KEY.counters.$CIRCLE_PROJECT_REPONAME.production.test.coverage `./node_modules/.bin/coverage-percentage ./coverage/lcov.info --lcov`" | nc -uw0 carbon.hostedgraphite.com 2003
    - rm -rf transformer transformer-mr*
deployment:
  production:
    branch: master
    commands:
      - node_modules/deployment-helpers/nodeApps/postRelease.sh production
  staging:
    branch: staging
    commands:
      - node_modules/deployment-helpers/nodeApps/postRelease.sh staging

experimental:
  notify:
    branches:
      only:
        - master
        - staging
